__build:

dot-target = $(dir $@).$(notdir $@)
kecho := :
define filechk
	mkdir -p build/$(dir $@);					\
	{ $(filechk_$(1)); } > $(dot-target).tmp;		\
	if [ ! -r $@ ] || ! cmp -s $@ $(dot-target).tmp; then	\
		$(kecho) '  UPD     $@';			\
		mv -f $(dot-target).tmp $@;			\
	fi
endef

define filechk_offsets
	 echo "#ifndef $2"; \
	 echo "#define $2"; \
	 echo "/*"; \
	 echo " * DO NOT MODIFY."; \
	 echo " *"; \
	 echo " * This file was generated by Kbuild"; \
	 echo " */"; \
	 echo ""; \
	 sed -ne 's:^[[:space:]]*\.ascii[[:space:]]*"\(.*\)".*:\1:; \
		/^->/{s:->#\(.*\):/* \1 */:; \
		s:^->\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; \
		s:->::; p;}' < $<; \
	 echo ""; \
	 echo "#endif"
endef

filechk_gentimeconst = echo 1000 | bc -q $<

bounds-file := build/include/generated/bounds.h
always-y := $(bounds-file)
targets := build/kernel/bounds.s
$(bounds-file): build/kernel/bounds.s
	@ $(call filechk,offsets,__LINUX_BOUNDS_H__)
timeconst-file := build/include/generated/timeconst.h
$(timeconst-file): kernel/time/timeconst.bc
	@ $(call filechk,gentimeconst)
offsets-file := build/include/generated/asm-offsets.h
always-y += $(offsets-file)
targets += build/arch/x86/kernel/asm-offsets.s
build/arch/x86/kernel/asm-offsets.s: $(timeconst-file) $(bounds-file)
$(offsets-file): build/arch/x86/kernel/asm-offsets.s
	@ $(call filechk,offsets,__ASM_OFFSETS_H__)

build/%.s: %.c
	@echo "  CC     " $@
	$(Q) gcc $(LINUXINCLUDE) $(KBUILD_CFLAGS) -S -o $@ $<

__build: $(always-y)

$(shell mkdir -p build/kernel build/arch/x86/kernel)
